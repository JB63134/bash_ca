#!/usr/bin/env bash

CONTROL_OPS=("||" "&&" "|&" "|" ";" "&")

is_control_op() {
    local token="$1"
    for op in "${CONTROL_OPS[@]}"; do
        [[ "$token" == "$op" ]] && return 0
    done
    return 1
}

preprocess_ops() {
    local s="$1"
    # Longest operators first to avoid splitting their components incorrectly
    s="${s//|&/ |& }"
    s="${s//||/ || }"
    s="${s//&&/ && }"
    s="${s//;/ ; }"
    s="${s//|/ | }"
    s="${s//&/ & }"
    echo "$s"
}

parse_bash_command() {
    local input
    input="$(preprocess_ops "$1")"

    local tokens=()
    read -r -a tokens <<< "$input"

    local current_cmd=()
    local commands=()
    local ops=()

    for tok in "${tokens[@]}"; do
        if is_control_op "$tok"; then
            if [[ ${#current_cmd[@]} -gt 0 ]]; then
                commands+=("$(printf "%s " "${current_cmd[@]}")")
                ops+=("$tok")
                current_cmd=()
            fi
        else
            current_cmd+=("$tok")
        fi
    done

    if [[ ${#current_cmd[@]} -gt 0 ]]; then
        commands+=("$(printf "%s " "${current_cmd[@]}")")
        ops+=("")
    fi

    echo "=== Parsed Commands ==="
    for ((i=0; i<${#commands[@]}; i++)); do
        echo "$((i+1)). Command: ${commands[$i]}"
        [[ -n "${ops[$i]}" ]] && echo "   Operator: ${ops[$i]}"
    done
}

parse() {
    if [[ -n "$1" ]]; then
        fcmd="$*"
    else
        fcmd="$(fc -ln -1)"
    fi

    parse_bash_command "$fcmd"
}

